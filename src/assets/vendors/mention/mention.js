!function(e){e.fn.extend({mention:function(t){this.opts={users:[],delimiter:"@",sensitive:!0,emptyQuery:!1,queryBy:["name","username"],typeaheadOpts:{}};var r=e.extend({},this.opts,t),i=function(e){var t;if(r.emptyQuery){var i=this.query.toLowerCase(),n=this.$element[0].selectionStart;if(i.slice(n-1,n)==r.delimiter)return!0}for(t in r.queryBy)if(e[r.queryBy[t]]){var s,a=e[r.queryBy[t]].toLowerCase(),u=this.query.toLowerCase().match(new RegExp(r.delimiter+"\\w+","g"));if(u)for(s=0;s<u.length;s++){var o=u[s].substring(1).toLowerCase(),h=new RegExp(r.delimiter+a,"g"),m=this.query.toLowerCase().match(h);if(-1!=a.indexOf(o)&&null===m)return!0}}},n=function(e){var t,i=this.query,n=this.$element[0].selectionStart;for(t=n;t>=0&&i[t]!=r.delimiter;t--);i.substring(t,n);var s=i.substring(0,t),a=i.substring(n);i=s+r.delimiter+e+a;return this.tempQuery=i,i},s=function(e){if(e.length&&r.sensitive){var t,i=function(e,t){var i;for(i=t;i>=0&&e[i]!=r.delimiter;i--);return e.substring(i,t)}(this.query,this.$element[0].selectionStart).substring(1),n=e.length,s={highest:[],high:[],med:[],low:[]},a=[];if(1==i.length){for(t=0;t<n;t++){var u=e[t];u.username[0]==i?s.highest.push(u):u.username[0].toLowerCase()==i.toLowerCase()?s.high.push(u):-1!=u.username.indexOf(i)?s.med.push(u):s.low.push(u)}for(t in s){var o;for(o in s[t])a.push(s[t][o])}return a}}return e};return e.fn.typeahead.Constructor.prototype.render=function(t){var i=this;return(t=e(t).map(function(t,n){t=e(i.options.item).attr("data-value",n.username);var s=e("<div />");return n.image&&s.append('<img class="mention_image" src="'+n.image+'">'),n.name&&s.append('<b class="mention_name">'+n.name+"</b>"),n.username&&s.append('<span class="mention_username"> '+r.delimiter+n.username+"</span>"),t.find("a").html(i.highlighter(s.html())),t[0]})).first().addClass("active"),this.$menu.html(t),this},this.each(function(){var t=e(this);(function(){if(void 0===e)throw new Error("jQuery is Required");if(void 0===e.fn.typeahead)throw new Error("Typeahead is Required");return!0})()&&t.typeahead(e.extend({source:r.users,matcher:i,updater:n,sorter:s},r.typeaheadOpts))})}})}(jQuery);